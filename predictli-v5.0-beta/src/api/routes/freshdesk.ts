import { Router } from 'express'; import { z } from 'zod'; import { db } from '../../db/index.js'; import { org_company, org_job } from '../../db/schema.js'; import { publishEvent } from '../../events/publish.js'; export const freshdesk=Router(); const Body=z.object({ sender:z.string().email(), subject:z.string(), body:z.string(), company:z.string().optional(), location:z.string().optional() }); freshdesk.post('/webhooks/freshdesk', async (req,res)=>{ const p=Body.safeParse(req.body); if(!p.success) return res.status(400).json({error:p.error.flatten()}); const { sender, subject, body, company, location }=p.data; const [co]=await db.insert(org_company).values({ name:company??'Unknown Co' }).returning(); const [job]=await db.insert(org_job).values({ company_id:co.id, title:subject, description:body, location:location??null }).returning(); await publishEvent('job.email_order_received',{ job_id:job.id, company_id:co.id, sender }); res.status(201).json({ job_id:job.id, company_id:co.id }); });
