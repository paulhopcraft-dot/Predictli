import { Router } from 'express'; import { z } from 'zod'; import { sign, verify } from '../../services/auth.js'; import { env } from '../../config/env.js'; export const auth=Router(); const Login=z.object({username:z.string(),password:z.string()}); auth.post('/auth/login',(req,res)=>{ const p=Login.safeParse(req.body); if(!p.success) return res.status(400).json({error:p.error.flatten()}); const {username,password}=p.data; if(username===env.ADMIN_USER && password===env.ADMIN_PASS) return res.json({token:sign(username)}); return res.status(401).json({error:'Invalid credentials'}); }); export function requireAuth(req:any,res:any,next:any){ try{ const hdr=req.headers['authorization']||''; const token=hdr.startsWith('Bearer ')?hdr.slice(7):''; if(!token) return res.status(401).json({error:'Missing token'}); (req as any).user=verify(token); next(); } catch(e){ return res.status(401).json({error:'Unauthorized'}); } }
