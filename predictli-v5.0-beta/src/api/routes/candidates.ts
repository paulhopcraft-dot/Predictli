import { Router } from 'express'; import { z } from 'zod'; import { db } from '../../db/index.js'; import { per_person, per_candidate, per_profile } from '../../db/schema.js'; import { publishEvent } from '../../events/publish.js'; export const candidates=Router(); const Create=z.object({ first_name:z.string(), last_name:z.string(), email:z.string().email(), phone:z.string().optional(), headline:z.string().optional(), skills:z.array(z.string()).optional(), experience_years:z.number().int().optional(), location:z.string().optional(), availability:z.string().optional() }); candidates.post('/', async (req,res)=>{ const p=Create.safeParse(req.body); if(!p.success) return res.status(400).json({error:p.error.flatten()}); const d=p.data; const [person]=await db.insert(per_person).values({ first_name:d.first_name, last_name:d.last_name, email:d.email, phone:d.phone??null }).returning(); const [cand]=await db.insert(per_candidate).values({ person_id:person.id, status:'new', location:d.location??null, availability:d.availability??'unknown' }).returning(); await db.insert(per_profile).values({ candidate_id:cand.id, headline:d.headline??null, skills:JSON.stringify(d.skills||[]), experience_years:d.experience_years||0 }); await publishEvent('candidate.created',{candidate_id:cand.id}); res.status(201).json({ candidate_id:cand.id, person_id:person.id }); });
