import { Router } from 'express'; import { z } from 'zod'; import { db } from '../../db/index.js'; import { org_company, org_job } from '../../db/schema.js'; import { publishEvent } from '../../events/publish.js'; export const jobs=Router(); const Create=z.object({ company_name:z.string(), title:z.string(), description:z.string().optional(), location:z.string().optional(), salary_min:z.number().int().optional(), salary_max:z.number().int().optional() }); jobs.post('/', async (req,res)=>{ const p=Create.safeParse(req.body); if(!p.success) return res.status(400).json({error:p.error.flatten()}); const d=p.data; const [co]=await db.insert(org_company).values({ name:d.company_name }).returning(); const [job]=await db.insert(org_job).values({ company_id:co.id, title:d.title, description:d.description??null, location:d.location??null, salary_min:d.salary_min??null, salary_max:d.salary_max??null }).returning(); await publishEvent('job.created',{job_id:job.id, company_id:co.id}); res.status(201).json({ job_id:job.id, company_id:co.id }); });
